# Компиляция в байт-код

Перед непосредственно исполнением программы она компилируется в специальный язык - байт-код. Он состоит из
инструкций для стековой виртуальной машины. Она стековая, так как все данные в ней хранятся и преобразуются на стеке (в
смысле структуры данных, а не хранения в памяти компьютера).

Виртуальная машина состоит из трёх стеков:

1. Стек вызовов функций: каждый элемент в нём - это пара из двух чисел (номер строки, из которой была вызвана функция, и
   количество её аргументов). Коротко - стек вызовов.
2. Стек аргументов функций: на него кладутся аргументы функции перед её вызовом. Коротко - стек аргументов.
3. Стек расчёта значений: на нём выполняются операции с данными. Коротко - стек вычислений.

Исполнителю на вход поступает массив из команд байт-кода и их аргументов. Он начинает исполнение с первой команды.

## Команды байт-кода

1. INCREMENT n - увеличить на 1 значение в n-й с конца ячейке стека вычислений.
2. DECREMENT n - уменьшить на 1 значение в n-й с конца ячейке стека вычислений.
3. POP_JUMP_IF_ZERO n - убрать последнее значение со стека вычислений,
   если оно 0 - прыгнуть на строку с номером n,
   иначе - продолжить исполнение со следующей строки.
4. JUMP_IF_NONZERO n - посмотреть на последнее значение в стеке вычислений,
   если 0 - продолжить исполнение со следующей строки,
   иначе - прыгнуть на строку с номером n.
5. CALL_FUNCTION - запускает процедуру вызова функции. Процедура такова:
    1. На стек аргументов переносятся последовательно все значения из стека вычислений до тех пор,
       пока не встретится значение, положенное в него инструкцией LOAD_CALL.
    2. Из стека вычислений убирается последнее значение (это номер строки, с которой начинается вызываемая функция),
       оно не кладётся на стек аргументов.
    3. На стек вызовов кладётся номер текущей строки и количество аргументов функции.
    4. Исполнение переходит к строке, в которой начинается вызываемая функция.
6. LOAD n - кладёт n-й с конца элемент в стеке аргументов наверх стека вычислений.
7. LOAD_CONST n - кладёт число n на стек вычислений.
8. LOAD_CALL n - кладёт на стек вычислений номер строчки для вызова функции (исполнитель байт-кода умеет отличать номер
   строки от обычного значения, это нужно для команды CALL_FUNCTION)
9. COPY n - берёт n-й с конца элемент в стеке аргументов и кладёт его наверх стека вычислений.
10. RETURN - возвращает исполнение предыдущей функции, при этом со стека вызовов убирается последнее значение (из него
    мы как раз узнаём, на какую строку надо вернуться), со стека аргументов убираются все аргументы текущей функции.
    Каждая функция после своей работы должна оставлять наверху стека вычислений ровно одно новое число (то есть при
    вызове функции со стека вычислений перекладываются аргументы функции на стек аргументов, а после этого вместо них
    остаётся одно число - результат работы функции).
11. POP n - убирает n-й с конца элемент со стека вычислений
12. HALT - заканчивает исполнение программы. Последнее значение в стеке вычислений является результатом работы
    алгоритма.

## Пример байт-кода для функции сложения двух чисел:

ADD:
1. LOAD 0
2. POP_JUMP_IF_ZERO 9
3. LOAD 1
4. LOAD 0
5. INCREMENT 1
6. DECREMENT 0
7. JUMP_IF_NONZERO 5
8. POP_JUMP_IF_ZERO 10
9. LOAD 1
10. RETURN

При этом вычисление 2 + 3 будет выглядеть так:

1. LOAD_CALL ADD
2. LOAD_CONST 3
3. LOAD_CONST 2
4. CALL_FUNCTION
5. HALT

Здесь для простоты ADD обозначает номер строки, где находится первая команда функции ADD
